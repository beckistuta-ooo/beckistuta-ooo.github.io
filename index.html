<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>簡單 Pomodoro 計時器</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>🍅 Pomodoro 計時器</h1>
        
        <div class="session-type" id="sessionType">工作時間</div>
        
        <div class="mode-buttons">
            <button class="mode-btn active work" id="workMode" onclick="switchMode('work')">工作時間</button>
            <button class="mode-btn short-break" id="shortBreakMode" onclick="switchMode('shortBreak')">短休息</button>
            <button class="mode-btn long-break" id="longBreakMode" onclick="switchMode('longBreak')">長休息</button>
        </div>
        
        <div class="progress-ring">
            <svg width="200" height="200">
                <circle class="progress-ring__background" cx="100" cy="100" r="80"></circle>
                <circle class="progress-ring__circle" cx="100" cy="100" r="80" 
                        stroke-dasharray="502.65" stroke-dashoffset="502.65" id="progressCircle"></circle>
            </svg>
        </div>
        
        <div class="timer-display" id="timerDisplay">25:00</div>
        
        <div class="reminder-message" id="reminderMessage" style="display: none;">
            <span id="reminderText">⏰ 提醒時間到！</span>
        </div>
        
        <div class="controls">
            <button class="start-btn" id="startBtn" onclick="startTimer()">開始</button>
            <button class="pause-btn" id="pauseBtn" onclick="pauseTimer()">暫停</button>
            <button class="reset-btn" id="resetBtn" onclick="resetTimer()">重置</button>
            <button class="reset-btn" id="resetStatsBtn" onclick="resetAllStats()" style="margin-left: 10px;">重置統計</button>
        </div>
        
        <div class="statistics">
            <div class="stat-item">
                <div class="stat-value" id="completedPomodoros">0</div>
                <div class="stat-label">已完成工作數</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="currentCycle">0</div>
                <div class="stat-label">目前週期進度</div>
            </div>
        </div>
        
        <div class="settings-wrapper">
            <button class="settings-toggle" onclick="toggleSettings()">
                ⚙️ 設定 <span id="settingsArrow">▼</span>
            </button>
            
            <div class="settings" id="settingsPanel" style="display: none;">
                <div class="settings-grid">
                    <div class="setting-group">
                        <label for="workTime">工作時間 (分鐘):</label>
                        <input type="number" id="workTime" value="25" min="1" max="60" onchange="updateSettings()">
                    </div>
                    <div class="setting-group">
                        <label for="shortBreakTime">短休息 (分鐘):</label>
                        <input type="number" id="shortBreakTime" value="5" min="1" max="30" onchange="updateSettings()">
                    </div>
                    <div class="setting-group">
                        <label for="longBreakTime">長休息 (分鐘):</label>
                        <input type="number" id="longBreakTime" value="15" min="1" max="60" onchange="updateSettings()">
                    </div>
                    <div class="setting-group">
                        <label for="sessionsPerLongBreak">工作週期數:</label>
                        <input type="number" id="sessionsPerLongBreak" value="4" min="2" max="10" onchange="updateSettings()">
                    </div>
                    <div class="setting-group">
                        <label for="reminderTime">提醒時間 (分鐘):</label>
                        <input type="number" id="reminderTime" value="5" min="1" max="15" onchange="updateSettings()">
                    </div>
                </div>
                
                <div class="controls-section">
                    <div class="setting-group checkbox-group">
                        <label for="soundToggle">
                            <input type="checkbox" id="soundToggle" checked onchange="toggleSound()"> 
                            🔊 啟用音效
                        </label>
                    </div>
                    
                    <div class="setting-group sound-setting">
                        <label for="reminderSoundSelect">提醒音效:</label>
                        <div class="sound-selection">
                            <select id="reminderSoundSelect" onchange="changeReminderSound()">
                                <option value="gentle">🎵 溫和音效</option>
                                <option value="chime">🔔 鈴聲音效</option>
                                <option value="nature">🌿 自然音效</option>
                                <option value="digital">🤖 數位音效</option>
                                <option value="piano">🎹 鋼琴音效</option>
                                <option value="bell">🔕 單音鈴聲</option>
                                <option value="soft">💫 輕柔提示</option>
                            </select>
                            <button class="preview-btn" onclick="previewReminderSound()">試聽</button>
                        </div>
                    </div>
                    
                    <div class="setting-group sound-setting">
                        <label for="completionSoundSelect">完成音效:</label>
                        <div class="sound-selection">
                            <select id="completionSoundSelect" onchange="changeCompletionSound()">
                                <option value="gentle">🎵 溫和音效</option>
                                <option value="chime">🔔 鈴聲音效</option>
                                <option value="nature">🌿 自然音效</option>
                                <option value="digital">🤖 數位音效</option>
                                <option value="piano">🎹 鋼琴音效</option>
                                <option value="fanfare">🎺 勝利音效</option>
                                <option value="ascending">📈 上升音階</option>
                            </select>
                            <button class="preview-btn" onclick="previewCompletionSound()">試聽</button>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <button class="notification-btn" onclick="requestNotificationPermission()">🔔 啟用通知權限</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let timer = null;
        let isRunning = false;
        let currentMode = 'work'; // 'work', 'shortBreak', 'longBreak'
        let timeLeft = 25 * 60; // 25 minutes in seconds
        let totalTime = 25 * 60;
        
        // 統計變數
        let completedPomodoros = 0;
        let currentCycle = 0;
        
        // 提醒功能變數
        let reminderShown = false;
        let titleFlashInterval = null;
        let originalTitle = document.title;
        
        // 音效控制變數
        let audioContext = null;
        let soundEnabled = true;
        let reminderSoundTheme = 'gentle';
        let completionSoundTheme = 'gentle';

        const timerDisplay = document.getElementById('timerDisplay');
        const sessionType = document.getElementById('sessionType');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const progressCircle = document.getElementById('progressCircle');
        const workTimeInput = document.getElementById('workTime');
        const shortBreakTimeInput = document.getElementById('shortBreakTime');
        const longBreakTimeInput = document.getElementById('longBreakTime');
        const sessionsPerLongBreakInput = document.getElementById('sessionsPerLongBreak');
        const reminderTimeInput = document.getElementById('reminderTime');
        const reminderMessage = document.getElementById('reminderMessage');
        const reminderText = document.getElementById('reminderText');
        const soundToggle = document.getElementById('soundToggle');
        const reminderSoundSelect = document.getElementById('reminderSoundSelect');
        const completionSoundSelect = document.getElementById('completionSoundSelect');
        
        const workModeBtn = document.getElementById('workMode');
        const shortBreakModeBtn = document.getElementById('shortBreakMode');
        const longBreakModeBtn = document.getElementById('longBreakMode');
        
        // 統計顯示元素
        const completedPomodorosDisplay = document.getElementById('completedPomodoros');
        const currentCycleDisplay = document.getElementById('currentCycle');

        const circumference = 2 * Math.PI * 80; // 80 is the radius
        progressCircle.style.strokeDasharray = circumference;

        const modes = {
            work: {
                name: '工作時間',
                color: '#e74c3c',
                getTime: () => parseInt(workTimeInput.value) * 60
            },
            shortBreak: {
                name: '短休息',
                color: '#27ae60',
                getTime: () => parseInt(shortBreakTimeInput.value) * 60
            },
            longBreak: {
                name: '長休息',
                color: '#3498db',
                getTime: () => parseInt(longBreakTimeInput.value) * 60
            }
        };

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function updateDisplay() {
            timerDisplay.textContent = formatTime(timeLeft);
            
            const progress = 1 - (timeLeft / totalTime);
            const offset = circumference * progress;
            progressCircle.style.strokeDashoffset = circumference - offset;
        }

        function switchMode(mode) {
            if (isRunning) return; // 不允許在運行時切換模式
            
            currentMode = mode;
            
            // 重置提醒狀態
            reminderShown = false;
            clearVisualReminder();
            
            // 更新按鈕樣式
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(mode + 'Mode').classList.add('active');
            
            // 更新 body class 以套用背景和光暈
            document.body.className = '';
            if (mode === 'work') {
                document.body.classList.add('work-mode');
            } else if (mode === 'shortBreak') {
                document.body.classList.add('short-break-mode');
            } else if (mode === 'longBreak') {
                document.body.classList.add('long-break-mode');
            }
            
            // 更新顯示
            const modeConfig = modes[currentMode];
            sessionType.textContent = modeConfig.name;
            progressCircle.style.stroke = modeConfig.color;
            
            // 重置計時器到新模式的時間
            timeLeft = modeConfig.getTime();
            totalTime = timeLeft;
            
            updateDisplay();
        }

        function updateSettings() {
            if (!isRunning) {
                // 更新當前模式的時間
                const newTime = modes[currentMode].getTime();
                timeLeft = newTime;
                totalTime = newTime;
                updateDisplay();
            }
        }

        function startTimer() {
            if (!isRunning) {
                isRunning = true;
                startBtn.textContent = '進行中...';
                startBtn.disabled = true;
                
                // 重置提醒狀態（當繼續或重新開始時）
                reminderShown = false;
                
                timer = setInterval(() => {
                    timeLeft--;
                    updateDisplay();
                    
                    // 檢查是否需要顯示提醒
                    checkReminder();
                    
                    if (timeLeft <= 0) {
                        completeSession();
                    }
                }, 1000);
            }
        }

        function pauseTimer() {
            if (isRunning) {
                isRunning = false;
                clearInterval(timer);
                startBtn.textContent = '繼續';
                startBtn.disabled = false;
            }
        }

        function resetTimer() {
            isRunning = false;
            clearInterval(timer);
            startBtn.textContent = '開始';
            startBtn.disabled = false;
            
            // 重置提醒狀態
            reminderShown = false;
            clearVisualReminder();
            
            // 重置到當前模式的預設時間
            const modeConfig = modes[currentMode];
            timeLeft = modeConfig.getTime();
            totalTime = timeLeft;
            
            updateDisplay();
        }
        
        function resetAllStats() {
            completedPomodoros = 0;
            currentCycle = 0;
            updateStatistics();
        }
        
        function updateStatistics() {
            completedPomodorosDisplay.textContent = completedPomodoros;
            currentCycleDisplay.textContent = currentCycle;
        }
        
        function checkReminder() {
            const reminderMinutes = parseInt(reminderTimeInput.value);
            const reminderTime = reminderMinutes * 60; // 轉換為秒數
            
            // 如果剩餘時間等於提醒時間，且還未顯示過提醒
            if (timeLeft === reminderTime && !reminderShown) {
                reminderShown = true;
                
                // 顯示提醒
                const modeConfig = modes[currentMode];
                const message = `提醒：${modeConfig.name}還剩 ${reminderMinutes} 分鐘！`;
                
                // Console 記錄
                console.log(message);
                
                // 視覺提醒效果
                showVisualReminder(message);
                
                // 播放提醒音效
                playReminderSound();
                
                // 如果支援通知，發送瀏覽器通知
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Pomodoro 提醒', {
                        body: message,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">⏰</text></svg>'
                    });
                }
            }
        }
        
        function showVisualReminder(message) {
            // 1. 顯示提醒文字
            reminderText.textContent = message;
            reminderMessage.style.display = 'block';
            
            // 2. 背景閃爛效果
            document.body.classList.add('reminder-flash');
            
            // 3. 標題閃爛效果
            let flashCount = 0;
            titleFlashInterval = setInterval(() => {
                if (flashCount % 2 === 0) {
                    document.title = '⏰ 提醒！';
                } else {
                    document.title = originalTitle;
                }
                flashCount++;
                
                // 镃6次後停止閃爛
                if (flashCount >= 6) {
                    clearInterval(titleFlashInterval);
                    document.title = originalTitle;
                }
            }, 500);
            
            // 5秒後自動隱藏提醒文字
            setTimeout(() => {
                reminderMessage.style.display = 'none';
                document.body.classList.remove('reminder-flash');
            }, 5000);
        }
        
        function clearVisualReminder() {
            // 清除提醒訊息
            reminderMessage.style.display = 'none';
            document.body.classList.remove('reminder-flash');
            
            // 停止標題閃爍
            if (titleFlashInterval) {
                clearInterval(titleFlashInterval);
                titleFlashInterval = null;
                document.title = originalTitle;
            }
        }
        
        // 音效主題配置
        const soundThemes = {
            gentle: {
                name: '溫和音效',
                reminder: [523.25, 659.25], // C5, E5
                completion: [523.25, 659.25, 783.99], // C5, E5, G5
                waveType: 'sine',
                volume: 0.1
            },
            chime: {
                name: '鈴聲音效',
                reminder: [880, 1108.73], // A5, C#6
                completion: [880, 1108.73, 1318.51], // A5, C#6, E6
                waveType: 'sine',
                volume: 0.12
            },
            nature: {
                name: '自然音效',
                reminder: [392, 523.25], // G4, C5
                completion: [392, 523.25, 659.25], // G4, C5, E5
                waveType: 'triangle',
                volume: 0.08
            },
            digital: {
                name: '數位音效',
                reminder: [698.46, 830.61], // F5, G#5
                completion: [698.46, 830.61, 987.77], // F5, G#5, B5
                waveType: 'square',
                volume: 0.06
            },
            piano: {
                name: '鋼琴音效',
                reminder: [261.63, 329.63], // C4, E4
                completion: [261.63, 329.63, 392], // C4, E4, G4
                waveType: 'triangle',
                volume: 0.15
            },
            bell: {
                name: '單音鈴聲',
                reminder: [800], // 單純的鈴聲
                completion: [800, 800, 800], // 三聲鈴響
                waveType: 'sine',
                volume: 0.12
            },
            soft: {
                name: '輕柔提示',
                reminder: [440, 554.37], // A4, C#5 - 很輕柔的提醒
                completion: [440, 554.37, 659.25], // A4, C#5, E5
                waveType: 'sine',
                volume: 0.06
            },
            fanfare: {
                name: '勝利音效',
                reminder: [523.25, 659.25], // C5, E5
                completion: [523.25, 659.25, 783.99, 1046.5], // C5, E5, G5, C6 - 勝利號角
                waveType: 'sine',
                volume: 0.18
            },
            ascending: {
                name: '上升音階',
                reminder: [523.25, 659.25], // C5, E5
                completion: [261.63, 329.63, 392, 523.25, 659.25], // C4→E4→G4→C5→E5 長音階
                waveType: 'triangle',
                volume: 0.12
            }
        };
        
        // WebAudio 音效函數
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        
        function playTone(frequency, duration, delay = 0, waveType = 'sine', volume = 0.1) {
            if (!soundEnabled || !soundToggle.checked) return;
            
            initAudioContext();
            
            setTimeout(() => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.frequency.value = frequency;
                osc.type = waveType;
                gain.gain.value = volume;
                gain.gain.setValueAtTime(0, audioContext.currentTime);
                gain.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                osc.start();
                osc.stop(audioContext.currentTime + duration);
            }, delay);
        }
        
        function playReminderSound() {
            const theme = soundThemes[reminderSoundTheme];
            theme.reminder.forEach((freq, index) => {
                const duration = theme.reminder.length === 1 ? 0.5 : 0.3; // 單音鈴聲持續久一點
                playTone(freq, duration, index * 200, theme.waveType, theme.volume);
            });
        }
        
        function playCompletionSound() {
            const theme = soundThemes[completionSoundTheme];
            theme.completion.forEach((freq, index) => {
                let delay = index * 150;
                let duration = 0.4;
                
                // 特殊處理不同音效的節奏
                if (completionSoundTheme === 'fanfare') {
                    delay = index * 120; // 勝利音效播放快一點
                    duration = 0.5;
                } else if (completionSoundTheme === 'ascending') {
                    delay = index * 180; // 上升音階慢一點，更有層次
                    duration = 0.6;
                } else if (completionSoundTheme === 'bell') {
                    delay = index * 300; // 鈴聲間隔長一點
                    duration = 0.8;
                }
                
                playTone(freq, duration, delay, theme.waveType, theme.volume * 1.2);
            });
        }
        
        function toggleSound() {
            soundEnabled = soundToggle.checked;
        }
        
        function changeReminderSound() {
            reminderSoundTheme = reminderSoundSelect.value;
        }
        
        function changeCompletionSound() {
            completionSoundTheme = completionSoundSelect.value;
        }
        
        function previewReminderSound() {
            if (!soundEnabled || !soundToggle.checked) {
                alert('請先啟用音效功能');
                return;
            }
            
            // 播放提醒音效
            const theme = soundThemes[reminderSoundTheme];
            theme.reminder.forEach((freq, index) => {
                const duration = theme.reminder.length === 1 ? 0.5 : 0.3;
                playTone(freq, duration, index * 200, theme.waveType, theme.volume);
            });
        }
        
        function previewCompletionSound() {
            if (!soundEnabled || !soundToggle.checked) {
                alert('請先啟用音效功能');
                return;
            }
            
            // 播放完成音效
            playCompletionSound();
        }
        
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            const arrow = document.getElementById('settingsArrow');
            
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                arrow.textContent = '▲';
            } else {
                panel.style.display = 'none';
                arrow.textContent = '▼';
            }
        }
        
        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        alert('通知權限已啟用！');
                        // 測試通知
                        new Notification('Pomodoro 計時器', {
                            body: '通知功能已成功啟用',
                            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🍅</text></svg>'
                        });
                    } else if (permission === 'denied') {
                        alert('通知權限被拒絕，請在瀏覽器設定中手動啟用。');
                    } else {
                        alert('通知權限請求被忽略。');
                    }
                });
            } else {
                alert('您的瀏覽器不支援通知功能。');
            }
        }

        function completeSession() {
            isRunning = false;
            clearInterval(timer);
            startBtn.textContent = '開始';
            startBtn.disabled = false;
            
            // 如果完成的是 Work 模式，更新統計
            if (currentMode === 'work') {
                completedPomodoros++;
                currentCycle++;
                updateStatistics();
            }
            
            // 播放完成音效
            playCompletionSound();
            
            // 顯示通知
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    const modeConfig = modes[currentMode];
                    new Notification(`${modeConfig.name}結束！`, {
                        body: currentMode === 'work' ? '該休息了！' : '該工作了！',
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🍅</text></svg>'
                    });
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            const modeConfig = modes[currentMode];
                            new Notification(`${modeConfig.name}結束！`);
                        }
                    });
                }
            }
            
            // 決定下一個模式
            let nextMode;
            if (currentMode === 'work') {
                // 檢查是否該進入長休息（使用可設定的週期數）
                const sessionsPerLongBreak = parseInt(sessionsPerLongBreakInput.value);
                if (currentCycle >= sessionsPerLongBreak) {
                    nextMode = 'longBreak';
                    currentCycle = 0; // 重置週期
                    updateStatistics();
                } else {
                    nextMode = 'shortBreak';
                }
            } else {
                // 從任何休息模式回到工作模式
                nextMode = 'work';
            }
            
            setTimeout(() => {
                const nextModeConfig = modes[nextMode];
                switchMode(nextMode);
                // 不自動開始下一個計時器，讓用戶手動開始
                console.log(`已切換至 ${nextModeConfig.name}，請點擊開始按鈕繼續`);
            }, 1000);
        }

        // 請求通知權限
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // 初始化顯示
        switchMode('work');
        updateStatistics();
    </script>
</body>
</html>